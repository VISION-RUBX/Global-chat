<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Chat</title>
<style>
  :root {
    --bg: #111;
    --card: #222;
    --text: #eee;
    --accent: #00ffff;
    --input-bg: #222;
    --text-muted: #aaa;
  }
  body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);}
  input,textarea{background:var(--input-bg);color:var(--text);border:none;padding:6px 8px;border-radius:6px;outline:none;}
  .discord-btn{background:var(--card);color:var(--text);border:none;padding:6px 12px;border-radius:6px;cursor:pointer;transition: all 0.2s;}
  .discord-btn:hover{transform: scale(1.05);background: var(--accent); color:#000;}
  .userRow, .channelRow{display:flex;align-items:center;padding:6px;gap:6px;cursor:pointer;}
  .userRow:hover,.channelRow:hover{background:#333;}
  .avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:#fff;}
  .statusDot{width:10px;height:10px;border-radius:50%;margin-left:auto;}
  .status-online{background: #2ecc71;}
  .status-away{background: #f1c40f;}
  .status-offline{background: #aaa;}
  .message{display:flex;gap:6px;padding:6px 0;}
  .msgBody{flex:1;}
  .msgText img{max-width:200px;max-height:200px;border-radius:6px;}
</style>
</head>
<body>

<div id="authDiv">
  <h2 id="authTitle">Login</h2>
  <input id="authUsername" placeholder="Username">
  <input id="authPassword" type="password" placeholder="Password">
  <input id="authConfirm" type="password" placeholder="Confirm Password" style="display:none">
  <button id="submitBtn" class="discord-btn" onclick="submitAuth()">Login</button>
  <div id="authMessage" style="color:red;margin-top:6px;"></div>
  <div>
    <span id="loginTab" onclick="switchAuth('login')">Login</span> | 
    <span id="signupTab" onclick="switchAuth('signup')">Signup</span>
  </div>
</div>

<div id="app" style="display:none; height:100vh; display:flex;">
  <div id="channelList" style="width:250px; background: var(--card); overflow-y:auto;"></div>
  <div style="flex:1; display:flex; flex-direction:column;">
    <div id="chatTitle" style="padding:12px; border-bottom:1px solid var(--card);"></div>
    <div id="messages" style="flex:1; overflow-y:auto; padding:12px;"></div>
    <div style="padding:12px; display:flex; gap:6px;">
      <input id="msgInput" placeholder="Type a message">
      <input id="msgImage" type="file" accept="image/*">
      <button class="discord-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>
  <div id="userList" style="width:200px; background: var(--card); overflow-y:auto;"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBWPZgfkzUW8Xtuesrdti_QPqwjKbVEYQk",
  authDomain: "global-chat-vision-bb8a9.firebaseapp.com",
  databaseURL: "https://global-chat-vision-bb8a9-default-rtdb.firebaseio.com",
  projectId: "global-chat-vision-bb8a9",
  storageBucket: "global-chat-vision-bb8a9.appspot.com",
  messagingSenderId: "341429711480",
  appId: "1:341429711480:web:5f7b0ca7c7b43ad0f2338d",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let username=null, channelsData=[], currentChannel=null, lastMsgTime=0, autoScroll=true, replyingToId=null, myStatus="online", userSettings={desktopNotifications:true};

// helper funcs
function uidColor(u){let hash=0;for(let i=0;i<u.length;i++){hash=u.charCodeAt(i)+((hash<<5)-hash);}return "hsl("+hash%360+",60%,50%)";}
function initials(name){return name?name.trim().charAt(0).toUpperCase():"?";}
function nowHHMM(ts){const d=ts?new Date(ts):new Date();return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;}
function escapeHTML(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));}

// pre-create admin
async function ensureAdminAccount(){
  const a="Visionadmin", e=a+"@chat.com", p="123123123123";
  const snap=await db.ref("users/"+a).once("value");
  if(!snap.exists()){
    try{
      await firebase.auth().createUserWithEmailAndPassword(e,p);
      await db.ref("users/"+a).set({settings:{desktopNotifications:true,admin:true},createdAt:Date.now()});
      console.log("Admin created!");
    }catch(err){console.error(err);}
  }
}
ensureAdminAccount();

// auth
function switchAuth(m){
  const isS=m==="signup";
  document.getElementById("loginTab").classList.toggle("active",m==="login");
  document.getElementById("signupTab").classList.toggle("active",isS);
  document.getElementById("authTitle").textContent=isS?"Create account":"Login";
  document.getElementById("authConfirm").style.display=isS?"block":"none";
  document.getElementById("submitBtn").textContent=isS?"Signup":"Login";
}
async function submitAuth(){
  const u=document.getElementById("authUsername").value.trim();
  const p=document.getElementById("authPassword").value;
  const c=document.getElementById("authConfirm").value;
  if(!u||!p) return;
  const isSignup=document.getElementById("signupTab").classList.contains("active");
  const email=u+"@chat.com";
  try{
    if(isSignup){
      if(p!==c){document.getElementById("authMessage").textContent="Passwords don't match"; return;}
      await firebase.auth().createUserWithEmailAndPassword(email,p);
      await db.ref("users/"+u).set({settings:{desktopNotifications:true},createdAt:Date.now()});
    }else await firebase.auth().signInWithEmailAndPassword(email,p);
    username=u; afterLogin();
  }catch(err){document.getElementById("authMessage").textContent=err.message;}
}
function afterLogin(){
  document.getElementById("authDiv").style.display="none";
  document.getElementById("app").style.display="flex";
  loadChannels(); loadUserList(); startPresence(); attachScrollHandler();
}

// presence
function startPresence(){
  const ref=db.ref("presence/"+username);
  ref.set({status:myStatus,lastSeen:Date.now()});
  ref.onDisconnect().remove();
}

// channels/users
async function loadChannels(){
  const snap=await db.ref("channels").once("value");
  channelsData=[];
  snap.forEach(ch=>{
    const data=ch.val();
    channelsData.push({id:ch.key,...data});
  });
  renderChannels();
}
function renderChannels(){
  const list=document.getElementById("channelList"); list.innerHTML="";
  channelsData.forEach(ch=>{
    const row=document.createElement("div"); row.className="channelRow"; row.textContent=ch.id;
    row.onclick=()=>joinChannel(ch.id);
    list.appendChild(row);
  });
}
async function loadUserList(){
  const snap=await db.ref("users").once("value");
  const presenceSnap=await db.ref("presence").once("value");
  const list=document.getElementById("userList"); list.innerHTML="";
  snap.forEach(u=>{
    const div=document.createElement("div"); div.className="userRow";
    div.innerHTML=`<div class="avatar" style="background:${uidColor(u.key)}">${initials(u.key)}</div>${u.key}`;
    div.onclick=()=>createDMWith(u.key);
    list.appendChild(div);
  });
}

// join channel/DM
async function joinChannel(name){
  currentChannel=name;
  document.getElementById("messages").innerHTML="";
  document.getElementById("chatTitle").textContent=name;
  db.ref("messages/"+name).on("child_added",snap=>appendMessage(snap.val(),snap.key));
}
async function createDMWith(other){
  if(other===username) return;
  const id=[username,other].sort().join("__"); 
  const snap=await db.ref("channels/dm__"+id).once("value");
  if(!snap.exists()) await db.ref("channels/dm__"+id).set({type:"dm",members:{[username]:true,[other]:true}});
  joinChannel("dm__"+id);
}

// messages
async function appendMessage(m,id){
  const container=document.getElementById("messages");
  const div=document.createElement("div"); div.className="message";
  let content=escapeHTML(m.text);
  if(m.image) content=`<img src="${m.image}">`;
  div.innerHTML=`<div class="avatar" style="background:${uidColor(m.user)}">${initials(m.user)}</div><div class="msgBody"><b>${m.user}</b> ${nowHHMM(m.ts)}<div class="msgText">${content}</div></div>`;
  container.appendChild(div);
  if(autoScroll) container.scrollTop=container.scrollHeight;
}
async function sendMessage(){
  const input=document.getElementById("msgInput"); if(!input.value.trim()&&!document.getElementById("msgImage").files.length) return;
  const now=Date.now();
  const msgRef=db.ref("messages/"+currentChannel).push();
  let msg={user:username,text:input.value.trim(),ts:now};
  const file=document.getElementById("msgImage").files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=(e)=>{msg.image=e.target.result; msgRef.set(msg);};
    reader.readAsDataURL(file);
  }else msgRef.set(msg);
  input.value=""; document.getElementById("msgImage").value="";
}

// scroll
function attachScrollHandler(){
  const m=document.getElementById("messages");
  m.onscroll=()=>{autoScroll=m.scrollHeight-m.scrollTop<800;};
}

// auth state
firebase.auth().onAuthStateChanged(u=>{if(u&&!username){username=u.email.split("@")[0]; afterLogin();}});
</script>
</body>
</html>
